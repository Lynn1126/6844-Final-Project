@model CardTradeHub.Models.Card
@using System.Security.Claims

@{
    ViewData["Title"] = "Card Details";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <div class="card-img-container mb-4" style="position: relative; padding-bottom: 100%; height: 0; overflow: hidden; border-radius: 8px;">
                            <img src="@Model.ImageUrl" alt="@Model.Title" 
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" />
                        </div>
                    }
                    else
                    {
                        <div class="text-center mb-4">
                            <p>No image available</p>
                        </div>
                    }

                    <h1 class="card-title mb-3">@Model.Title</h1>
                    <div class="card-details">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Category:</strong> <span class="text-muted">@Model.Category</span></p>
                                <p class="mb-2"><strong>Status:</strong> <span class="badge bg-@(Model.Status == "Available" ? "success" : "secondary")">@Model.Status</span></p>
                                <p class="mb-2"><strong>Price:</strong> <span class="text-primary fw-bold">$@Model.Price.ToString("F2")</span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Condition:</strong> <span class="text-muted">@Model.Condition</span></p>
                                <p class="mb-2"><strong>Seller:</strong> <span class="text-muted">@Model.User.Username</span></p>
                                <p class="mb-2"><strong>Listed:</strong> <span class="text-muted">@Model.ListedDate.ToString("MMM dd, yyyy", System.Globalization.CultureInfo.InvariantCulture)</span></p>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h5>Description</h5>
                            <p class="card-text">@Model.Description</p>
                        </div>
                    </div>

                    @{
                        var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                        var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
                        var isAvailable = Model.Status == "Available";
                        var isSeller = userId != null && Model.UserID == int.Parse(userId);
                    }

                    <div class="d-flex justify-content-between align-items-center">
                        <a href="javascript:history.back()" class="btn btn-secondary">Back to List</a>
                        @if (isAuthenticated && !isSeller && isAvailable)
                        {
                            <form id="purchaseForm" method="post">
                                @Html.AntiForgeryToken()
                                <button type="button" class="btn btn-primary" onclick="purchaseCard(@Model.CardID)">Purchase</button>
                            </form>
                        }
                        @if (isSeller)
                        {
                            <div class="text-muted">This is your card listing.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function purchaseCard(cardId) {
            if (confirm('Are you sure you want to purchase this card?')) {
                var token = $('input[name="__RequestVerificationToken"]').val();
                $.ajax({
                    url: '/Cards/Purchase/' + cardId,
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: token
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = '/Cards';
                        } else {
                            alert(response.message || 'Purchase failed. Please try again.');
                        }
                    },
                    error: function() {
                        alert('An error occurred while processing your request.');
                    }
                });
            }
        }
    </script>
} 